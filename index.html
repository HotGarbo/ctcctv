<!DOCTYPE html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        html {
            height: 100%;
        }

        body {
            margin: 0;
            width: 100%;
            height: 100%;
            background: black;
        }
        main {
            display: grid;
            grid-template-columns: repeat(2, 50%);
            grid-template-rows: repeat(6, 16.666%);
            height: 100%;
            overflow: hidden;
        }
        @media (orientation: landscape) {
            main {
                grid-template-columns: repeat(4, 25%);
                grid-template-rows: repeat(3, 33.333%);
            }
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>

<body>
    <main></main>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
    <script>
        const DISTRICTS = [
            //"https://cwwp2.dot.ca.gov/data/d1/cctv/cctvStatusD01.json", // No streams
            //"https://cwwp2.dot.ca.gov/data/d2/cctv/cctvStatusD02.json", // No streams
            "https://cwwp2.dot.ca.gov/data/d3/cctv/cctvStatusD03.json",
            "https://cwwp2.dot.ca.gov/data/d4/cctv/cctvStatusD04.json",
            "https://cwwp2.dot.ca.gov/data/d5/cctv/cctvStatusD05.json",
            "https://cwwp2.dot.ca.gov/data/d6/cctv/cctvStatusD06.json",
            //"https://cwwp2.dot.ca.gov/data/d7/cctv/cctvStatusD07.json", // Single broken stream
            "https://cwwp2.dot.ca.gov/data/d8/cctv/cctvStatusD08.json",
            //"https://cwwp2.dot.ca.gov/data/d9/cctv/cctvStatusD09.json", // No streams
            //"https://cwwp2.dot.ca.gov/data/d10/cctv/cctvStatusD10.json", // Too many without CORS
            "https://cwwp2.dot.ca.gov/data/d11/cctv/cctvStatusD11.json", 
            //"https://cwwp2.dot.ca.gov/data/d12/cctv/cctvStatusD12.json", // Too many without CORS
        ];
        async function loadem() {
            const results = await Promise.allSettled(
                DISTRICTS.map(url => fetch(url)
                    .then(r => r.json())
                    .then(j => {
                        return j.data.reduce((a, o) => {
                            if (o.cctv.inService && o.cctv.imageData.streamingVideoURL) {
                                a.push(o.cctv);
                            }
                            return a;
                        }, [])
                    })
                )
            );
            return results.map(o => o.value).flat();
        }
        function popVid() {
            if (window.vidCount >= 12) return;
            const main = document.querySelector("main");
            const obj = window.vidUrls.pop();
            const src = obj.imageData.streamingVideoURL;
            console.debug("popVid", src);
            const vid = document.createElement("video");
            vid.muted = true;
            vid.playsInline = true;
            vid.autoplay = true;
            const canPlay = vid.canPlayType('application/vnd.apple.mpegurl');
            vid.onloadeddata = (ev) => {
                console.log("loadeddata", ev);
                ev.target.play();
                if (!canPlay) main.appendChild(ev.target);
                window.vidCount++;
                popVid();
            }
            if (canPlay) {
                vid.src = src;
                main.appendChild(vid);
                vid.onerror = (ev) => {
                    ev.target.remove();
                    popVid();
                }
            } else if (Hls.isSupported()) {
                var hls = new Hls();
                hls.on(Hls.Events.ERROR, function (event, data) {
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.log('fatal media error encountered, try to recover');
                                hls.recoverMediaError();
                                break;
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.error('fatal network error encountered', data);
                            // All retries and media options have been exhausted.
                            // Immediately trying to restart loading could cause loop loading.
                            // Consider modifying loading policies to best fit your asset and network
                            // conditions (manifestLoadPolicy, playlistLoadPolicy, fragLoadPolicy).
                            default:
                                // cannot recover
                                console.log("default case");
                                popVid();
                                vid.remove();
                                hls.destroy();
                                break;
                        }
                    }
                });
                hls.loadSource(src);
                hls.attachMedia(vid);
            }
        }
        function hlsErr(event, data) {

        }
        async function main() {
            window.vidUrls = shuffle(await loadem());
            window.vidCount = 0;
            popVid();
        }
        main();
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;

            // While there remain elements to shuffle.
            while (currentIndex > 0) {

                // Pick a remaining element.
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;

                // And swap it with the current element.
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }

            return array;
        }
    </script>
</body>